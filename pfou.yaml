buildPack: environment-helmfile
buildPackGitRef: jxlabs-nos
buildPackGitURL: https://github.com/nxmatic/jxlabs-nos-buildpacks
pipelineConfig:
  agent:
    image: jenkinsxio/jenkins-x-installer:0.0.27
    label: jenkins-go
  pipelines:
    post: {}
    pullRequest:
      pipeline:
        agent:
          image: gcr.io/build-jx-prod/jxlabs-nos/jxl:latest
        stages:
        - dir: /workspace/source
          name: pr-checks
          options:
            containerOptions:
              env:
              - name: HELM_PLUGINS
                value: /root/.cache/helm/plugins
              name: ""
              resources: {}
          steps:
          - args:
            - step
            - create
            - helmfile
            - --values
            - ../jx-requirements.values.yaml.gotmpl
            command: jx
            dir: /workspace/source
            name: create-helmfile
          - args:
            - lint
            command: helmfile
            dir: /workspace/source/system
            name: lint-helmfile-system
          - args:
            - lint
            command: helmfile
            dir: /workspace/source/apps
            name: lint-helmfile-apps
    release:
      pipeline:
        agent:
          image: gcr.io/build-jx-prod/jxlabs-nos/jxl:latest
        stages:
        - dir: /workspace/source
          name: release
          options:
            containerOptions:
              env:
              - name: HELM_PLUGINS
                value: /root/.cache/helm/plugins
              - name: XDG_CONFIG_HOME
                value: /builder/home
              - name: JX_SECRETS_YAML
                value: /secrets/jx-boot/secrets.yaml
              name: ""
              resources: {}
              volumeMounts:
              - mountPath: /secrets/jx-boot
                name: jx-boot-secrets
            volumes:
            - name: jx-boot-secrets
              secret:
                defaultMode: 420
                secretName: jx-boot-secrets
          steps:
          - args:
            - step
            - git
            - validate
            command: jx
            dir: /workspace/source
            name: validate-git
          - args:
            - step
            - verify
            - preinstall
            - --disable-verify-packages
            - --provider-values-dir="kubeProviders"
            command: jx
            dir: /workspace/source
            name: verify-preinstall
          - args:
            - step
            - create
            - helmfile
            - --values
            - ../jx-requirements.values.yaml.gotmpl
            command: jx
            dir: /workspace/source
            name: generate-helmfile
          - command: helmfile diff || true
            dir: /workspace/source/system
            name: helmfile-system-diff
          - args:
            - sync
            command: helmfile
            dir: /workspace/source/system
            name: helmfile-system
          - args:
            - step
            - verify
            - ingress
            - --ingress-namespace=nginx
            - --ingress-service=nginx-ingress-controller
            command: jx
            dir: /workspace/source
            name: verify-ingress
          - command: yq
            dir: /workspace/source/system
            name: augment-apps-helmfile
          - command: helmfile diff || true
            dir: /workspace/source/apps
            name: helmfile-apps-diff
          - args:
            - sync
            command: helmfile
            dir: /workspace/source/apps
            name: helmfile-apps
          - args:
            - step
            - git
            - credentials
            - -o
            - /builder/home/git/credentials
            command: jx
            dir: /workspace/source
            name: git-creds
          - args:
            - step
            - verify
            - env
            command: jx
            dir: /workspace/source
            name: verify-jenkins-x-environment
          - args:
            - step
            - scheduler
            - config
            - apply
            - --direct=true
            command: jx
            dir: /workspace/source
            name: install-pipelines
          - args:
            - update
            - webhooks
            - --verbose
            - --warn-on-fail
            command: jx
            dir: /workspace/source
            name: update-webhooks
          - args:
            - step
            - verify
            - install
            - --pod-wait-time
            - 30m
            command: jx
            dir: /workspace/source
            name: verify-installation

